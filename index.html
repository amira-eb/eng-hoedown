<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Securely Inserting User Generated Content and JSON Into Templates: A Cocktail Approach</title>

		<meta name="description" content="A talk about how to correctly and safely insert user created content and other JSON into the page">
		<meta name="author" content="Amira Anuar">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/serif.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h2>Securely Inserting User Generated Content and JSON Into Templates</h2>
					<h3>A Cocktail Approach</h3>
					<p>
						<small>Created by <a href="http://amiraanuar.com">Amira Anuar</a></small>
					</p>
				</section>

				<section>
					<h2>Securely? Why?</h2>
					<ul>
						<p class="fragment fade-in">"Browsers are extremely finicky beasts." - pmp</p>
					</ul>
						<img class="fragment fade-in" style="align: center;" src="http://media.giphy.com/media/hEMF9k5UHh2U0/giphy.gif"/>
					<aside class="notes">
						At the moment you may feel like this, by the end of the presentation you may feel more like...
					</aside>
				</section>

				<section>
						<img style="align: center;" src="https://40.media.tumblr.com/bc1de1db2e12d80cbb66b1ab41052340/tumblr_nwz96oZ3Pz1qewh5to1_500.jpg"/>
					<aside class="notes">
						this.
					</aside>
				</section>

				<section>
					<h2>Disclaimer</h2>
					<ul>
						<p class="fragment fade-in">insert image/note here related to this being a smorgasboard of various things and that I am not an expert</p>
					</ul>

					<aside class="notes">
						There is a LOT more to know when it comes to security than what I will be covering. This is called a cocktail approach as I'll be covering a little bit of a, b,and c, and x, y, and z, but hopefully the most important things you need to know when it comes to escaping JSON and User generated content within your templates.
					</aside>
				</section>

				<section style="text-align: left;">
					<h2 style="text-align: center;">Different Browser Contexts</h2>
					<li class="fragment fade-in">HTML Body -- <code>&lt;body&gt;${ text }&lt;/body&gt;</code></li>
					<li class="fragment fade-in">Element Attribute -- <code>&lt;a href="${ link }"&gt;My Site&lt;/a&gt;</code></li>
					<li class="fragment fade-in">JS String Literal -- <code>&lt;script&gt;var x='${foo}' &gt;/script&gt;</code></li>
					<li class="fragment fade-in">JSON Body Responses</li>
					<li class="fragment fade-in">E-mail addresses</li>
					<li class="fragment fade-in">URLs</li>
					<li class="fragment fade-in">So on...</li>
					<p>
					<aside class="notes">
						So, it's really important that engineers understand the context of where their untrusted data is being added to the template when thinking about the encoding.
						Keep these things in mind as I continue this presentation.
					</aside>
					</p>
				</section>

				<section data-markdown>
					<script type="text/template">
						<h2>An Example of Vulnerability</h2>

						```
						  < script >
						  	var x = '${ foo | n };'
						  < /script >

						  foo = "&#39;; alert(document.cookie);'"
						```
						<li style="text-align: left;" class="fragment fade-in">Why is this vulnerable?</li>
						<li style="text-align: left;" class="fragment fade-in">JavaScript on the client side will first decode the HTML entities, leaving:

						```
						  var x = " ;alert(document.cookie);"
						```
						<p>
						<aside class="notes">
							First I'm going to jump right into showing an example of why we do this, which is to prevent site vulnerabilities.
							<br>This is assuming I override the other j# variables. Otherwise we will get another error.
						</aside>
						</p>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						<h2>Never Trust Your Inputs!</h2>
						<img style="width:49%; float:left; margin-right:5px; margin-top:10%;" src="https://41.media.tumblr.com/cd5529211441b18a9342a266a0a7e2c9/tumblr_nwzbz9f9aV1qewh5to1_1280.png">
						<img style="width:49%; float:left;" src="https://40.media.tumblr.com/171de5eaf966937a0027cefee1a0cd68/tumblr_nwzc4mBDR31qewh5to1_1280.png">
						<aside class="notes">
							<liL>Never trust your inputs, just like you should never trust a friend when they tell you a drink is weak and has like one shot in it. Don't just assume it's good for you, and vet the contents first.</liL>
							<li>This is very important when it comes to templates and escaping, because we accept a lot of user-generated content and inputs, store them in our database, and then use those inputs in the formulation of the response bodies back to the clients</li>
							<li>You can have a variety of injection attacks such as XSS, SQLi, Command Injection, XXE and others, things I won't go into here</li>
							<li>Furthermore, you can have non functional ugly sites that break what the product requirements are (like being able to click register)</li>
						</aside>
					</script>
				</section>

				<section>
					<h2>How?</h2>
					<img style="align: center;" src="https://40.media.tumblr.com/e6cba5c78a42cb7a1c8731a8a7e9f7a1/tumblr_nwzjoaT61t1qewh5to1_1280.png"/>
					<aside class="notes">
						This is the cocktail part of the talk where I will talk about the various methods of escaping and stripping, and when you should probably use them.
					</aside>
				</section>


				<section data-markdown>
					<script type="text/template">
						<h2>clean_html, strip_html, strip_tags</h2>
						<aside class="notes">
							This is a common question - what are these doing and when do we use them?
						</aside>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						<h2>clean_html is like [alcohol analogy?]</h2>
						<li>Takes HTML, removes < script > tags and other attack vendors
						<li>Closes un-closed HTML tags</li>
						<li>Use this when you want to take the HTML data provided by the user, and display it on the page
						<aside class="notes">
							DEMO in the app. However, clean_html is not performant. If you have an explicit whitelist of tags...
						</aside>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						<h2>strip_html</h2>
						<li>Now uses <a href="http://bleach.readthedocs.org/en/latest/clean.html">bleach</a>, which is more performant
						<li>Pass in a 'whitelist' of tags</li>
						<li>All HTML is stripped but those tags</li>
						<li>Use strip_html instead of clean_html when you want no HTML tags, or just a few
						<li>I don't actually understand strip tags vs strip html, Paul?
						<aside class="notes">
							However, clean_html is not performant. If you have an explicit whitelist of tags...
						</aside>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						<h2>as_safe_markup</h2>
						<p>paul can we chat on what I should say on this? is it preferred to strip html and clean html? seems way better to me</p>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						<h2>escape_js, django.utils.html.escape</h2>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						<h2>Django 'escape' - Escapes a String's HTML</h2>
						<ul>
						<li class="fragment fade-in">< is converted to & lt;</li>
						<li class="fragment fade-in"> is converted to & gt;</li>
						<li class="fragment fade-in">' (single quote) is converted to & #39;</li>
						<li class="fragment fade-in">" (double quote) is converted to & quot;</li>
						<li class="fragment fade-in">& is converted to & amp;</li>
						<li class="fragment fade-in"> Does NOT get called if the string has already been "marked safe"</li>
						</ul>
						<aside class="notes">
							More on mark safe later (what should I say about when this should be used?)
						</aside>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						<h2>escapejs</h2>
						<ul>
						<li class="fragment fade-in">Escapes characters for use in JavaScript strings</li>
						<li class="fragment fade-in"><code>testing\r\njavascript \'string" &lt;b&gt;escaping</b></code></li>
						</ul>
						<aside class="notes">
							This does not make the string safe for use in HTML, but does protect you from syntax errors when using templates to generate JavaScript/JSON.
						</aside>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						<h2>escapejs is great, but safejson is better</h2>
						<ul>
						<li class="fragment fade-in">Outputs a Python data structure as JSON</li>
						<li class="fragment fade-in">Can pass in strings or more complex structures, and less likely to miss cases</li>
						<li class="fragment fade-in"><a href="https://phabricator.evbhome.com/D6955">Example</a></li>
						</ul>
						<aside class="notes">
							Like escapejs, this ensures that dangerous sequences are correctly escaped for use within a script block without opening a potential XSS hole.
						</aside>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						<h2>| n</h2>
						<ul>
						<p>From what I can tell, we should try to not use this. It basically tells us that this string is 'safe' so we do not double encode it, but that is dangerous in case i t is actually not safe. But we need it for translations...?
						</ul>
						<aside class="notes">
						</aside>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						<h2>| h</h2>
						<ul>
						<p>Unclear on what this does and if I should cover it.</p>
						</ul>
						<aside class="notes">
						</aside>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						<h2>Past relevant security issues and their fixes</h2>
						<ul>
						<p>If I have time I may go over a couple of these such as https://jira.evbhome.com/browse/EB-18312 which is fixed by checking if is_url.</p>
						</ul>
						<aside class="notes">
						</aside>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						<h2>So far, we reviewed...</h2>
						<ul>
							<li><code>strip_html</code></li>
							<li><code>clean_html</code></li>
							<li><code>| n </code></li>
							<li><code>| h </code></li>
							<li><code>safejson</code></li>
							<li><code>escapejs</code></li>
							<li><code>mark_safe</code></li>
							<li><code>as_safe_markup</code></li>
						</ul>
						<aside class="notes">
						</aside>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						<img src="https://38.media.tumblr.com/f576b011ae3c3b42323f5bcce8ac03fc/tumblr_inline_n9r1mnyYt61s89bo6.gif"/>
						<p class="fragment fade-in">Yes and no. There are a lot of different things I could've chosen to talk about, and many other edge cases and scenarios I didn't consider.
						But for now....</p>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						<img src="http://media.giphy.com/media/uddDNZtt72kBW/giphy.gif">
						<aside>Have fun safely and securely embedding user generated content / json!</aside>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
						<h1>Questions?</h1>
						<p class="fragment fade-in">Thank you to Paul, Tamara, Simon, and Darren for your knowledge and help! (I owe you all a drink.)</p>
					</script>
				</section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
